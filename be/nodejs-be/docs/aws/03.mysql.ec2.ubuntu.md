# Hướng dẫn cài đặt MySQL trên AWS EC2 Instance (Ubuntu)

> **Lưu ý**: File này hướng dẫn cài đặt MySQL Server trên Ubuntu EC2 instance. Nếu bạn sử dụng Amazon Linux, vui lòng xem file [03.mysql.ec2.md](./03.mysql.ec2.md)

## Tổng quan

Trên Windows, người ta thường sử dụng **MySQL Installer** để cài đặt MySQL Server và MySQL Workbench với giao diện đồ họa.
Trên Linux, chúng ta sử dụng **command line** để cài đặt MySQL Server và MySQL Client.

---

## 1. So sánh Ubuntu vs Amazon Linux

| Đặc điểm | Ubuntu | Amazon Linux |
| --- | --- | --- |
| Package Manager | **APT** (apt-get, apt) | **YUM** (yum, dnf) |
| Service Manager | **systemctl** (systemd) | **systemctl** (systemd) |
| User mặc định | ubuntu | ec2-user |
| Base Distribution | Debian | Red Hat Enterprise Linux |

---

## 2. Cập nhật hệ thống

### 2.1. Về APT Package Manager

**APT** (Advanced Package Tool) là package manager của Debian/Ubuntu. APT cho phép:

- ✅ Cài đặt packages (`apt install`)
- ✅ Cập nhật packages (`apt update`, `apt upgrade`)
- ✅ Xóa packages (`apt remove`, `apt purge`)
- ✅ Tìm kiếm packages (`apt search`)

**Sự khác biệt giữa `apt-get` và `apt`:**

- `apt-get`: Lệnh cũ, ổn định, dùng trong scripts
- `apt`: Lệnh mới hơn, thân thiện với người dùng, output đẹp hơn

### 2.2. Cập nhật package list

```bash
sudo apt update
```

**Giải thích lệnh:**

- `sudo`: Chạy lệnh với quyền superuser (root)
- `apt update`: Cập nhật danh sách packages từ repositories
- **Lưu ý**: Lệnh này KHÔNG cài đặt hay nâng cấp gì, chỉ cập nhật metadata

### 2.3. Nâng cấp các packages hiện có (Optional)

```bash
sudo apt upgrade -y
```

**Giải thích:**

- `apt upgrade`: Nâng cấp tất cả packages đã cài đặt lên phiên bản mới nhất
- `-y`: Tự động trả lời "yes" cho tất cả các câu hỏi xác nhận

---

## 3. Cài đặt MySQL Server

### 3.1. Cài đặt MySQL từ Ubuntu Repository

**Cách 1: Cài đặt từ Ubuntu default repository (Đơn giản nhất)**

```bash
sudo apt install mysql-server -y
```

**Giải thích:**

- `mysql-server`: Package chính chứa MySQL Server
- Ubuntu repository thường cung cấp phiên bản MySQL ổn định

**Kiểm tra version đã cài:**

```bash
mysql --version
```

### 3.2. Cài đặt MySQL phiên bản mới nhất từ MySQL Repository (Khuyến nghị)

Nếu bạn muốn phiên bản MySQL mới nhất:

**Bước 1:** Tải MySQL APT Repository

```bash
# Tải file .deb
wget https://dev.mysql.com/get/mysql-apt-config_0.8.29-1_all.deb

# Cài đặt repository
sudo dpkg -i mysql-apt-config_0.8.29-1_all.deb
```

**Giải thích:**

- `wget`: Công cụ download file từ internet
  - Syntax: `wget [options] [URL]`
  - Options: `-O file`: Lưu với tên file khác, `-c`: Tiếp tục download nếu bị gián đoạn
- `dpkg`: Debian Package Manager
  - `-i`: Install package từ file .deb
  - `-r`: Remove package
  - `-l`: List installed packages

**Bước 2:** Chọn phiên bản MySQL trong dialog

- Chọn "MySQL Server & Cluster"
- Chọn phiên bản MySQL 8.0 (hoặc mới nhất)
- Chọn "Ok"

**Bước 3:** Cập nhật package list và cài đặt

```bash
sudo apt update
sudo apt install mysql-server -y
```

---

## 4. Khởi động và quản lý MySQL Service

### 4.1. Về systemctl

**systemctl** là công cụ quản lý services trên Linux sử dụng systemd (giống Amazon Linux).

| Lệnh | Mô tả |
| --- | --- |
| `systemctl start <service>` | Khởi động service |
| `systemctl stop <service>` | Dừng service |
| `systemctl restart <service>` | Khởi động lại service |
| `systemctl status <service>` | Xem trạng thái service |
| `systemctl enable <service>` | Tự động khởi động service khi boot |

### 4.2. Khởi động MySQL

```bash
# Khởi động MySQL service
sudo systemctl start mysql

# Kiểm tra trạng thái
sudo systemctl status mysql
```

**Giải thích:**

- Service name trên Ubuntu là `mysql` (không phải `mysqld` như Amazon Linux)
- `status`: Hiển thị trạng thái service (active/running, stopped, failed, etc.)

### 4.3. Enable auto-start khi reboot (Khuyến nghị)

```bash
sudo systemctl enable mysql
```

**Kiểm tra MySQL đã chạy chưa:**

```bash
sudo systemctl is-active mysql
```

Output: `active` hoặc `inactive`

---

## 5. Lấy mật khẩu root tạm thời

### 5.1. Sự khác biệt quan trọng giữa Ubuntu và Amazon Linux

**⚠️ QUAN TRỌNG:**

- **Amazon Linux**: MySQL tạo mật khẩu tạm thời và lưu trong `/var/log/mysqld.log`
- **Ubuntu**: MySQL **KHÔNG** tạo mật khẩu tạm thời, sử dụng **auth_socket plugin**

### 5.2. Auth Socket Plugin trên Ubuntu

Ubuntu sử dụng `auth_socket` plugin, cho phép:

- User `root` của hệ thống có thể đăng nhập MySQL root **KHÔNG CẦN MẬT KHẨU**
- Chỉ cần dùng `sudo` để xác thực

### 5.3. Đăng nhập MySQL lần đầu

```bash
sudo mysql
```

**Giải thích:**

- Không cần `-u root -p` vì auth_socket tự động nhận diện user
- Phải dùng `sudo` vì chỉ root user của OS mới có thể đăng nhập

**Nếu gặp lỗi "Access denied":**

```bash
sudo mysql -u root
```

---

## 6. Đổi mật khẩu root và cấu hình xác thực

### 6.1. Đổi mật khẩu root

Sau khi đăng nhập vào MySQL bằng `sudo mysql`, chạy:

```sql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'YourNewPassword123!';
FLUSH PRIVILEGES;
```

**Giải thích:**

- `ALTER USER`: Thay đổi thông tin user
- `IDENTIFIED WITH mysql_native_password`: Đổi từ auth_socket sang password authentication
- `BY 'YourNewPassword123!'`: Đặt mật khẩu mới
- `FLUSH PRIVILEGES`: Reload bảng quyền để áp dụng thay đổi ngay lập tức

**Lưu ý về password policy:**

MySQL 8.0 yêu cầu mật khẩu mạnh:

- Ít nhất 8 ký tự
- Chữ hoa, chữ thường, số, ký tự đặc biệt

### 6.2. Kiểm tra cấu hình xác thực

```sql
SELECT user, host, plugin FROM mysql.user WHERE user = 'root';
```

**Output mong đợi:**

```text
+------+-----------+-----------------------+
| user | host      | plugin                |
+------+-----------+-----------------------+
| root | localhost | mysql_native_password |
+------+-----------+-----------------------+
```

### 6.3. Thoát và đăng nhập lại với mật khẩu

```bash
exit
```

Đăng nhập lại:

```bash
mysql -u root -p
```

Nhập mật khẩu mới vừa đặt.

---

## 7. Chạy MySQL Secure Installation

### 7.1. Về mysql_secure_installation

Script tự động giúp cấu hình bảo mật MySQL:

- ✅ Validate password plugin
- ✅ Xóa anonymous users
- ✅ Tắt remote root login
- ✅ Xóa test database
- ✅ Reload privilege tables

### 7.2. Chạy script

```bash
sudo mysql_secure_installation
```

**Các câu hỏi sẽ được hỏi:**

1. **VALIDATE PASSWORD COMPONENT**: `Y` (Khuyến nghị)
2. **Password validation policy**: Chọn `2` (STRONG)
3. **Change password for root**: `N` (đã đổi rồi) hoặc `Y` (nếu chưa)
4. **Remove anonymous users**: `Y`
5. **Disallow root login remotely**: `Y`
6. **Remove test database**: `Y`
7. **Reload privilege tables**: `Y`

---

## 8. Import dữ liệu từ file SQL

### 8.1. Chuẩn bị file SQL

Giả sử bạn có file `mysqlsampledatabase.sql` trên máy local.

### 8.2. Copy file SQL từ local lên EC2

```bash
scp -i "~/.ssh/your_key.pem" /path/to/mysqlsampledatabase.sql ubuntu@your-ec2-public-ip:~/
```

**Sự khác biệt với Amazon Linux:**

- Username là `ubuntu` thay vì `ec2-user`
- Thư mục home: `/home/ubuntu/`

**Giải thích SCP:**

- `scp`: Secure Copy Protocol - copy file qua SSH
- `-i "~/.ssh/your_key.pem"`: Private key để xác thực
- `ubuntu@your-ec2-public-ip`: User và IP của EC2
- `:~/`: Thư mục đích (home directory)

### 8.3. Import file SQL vào MySQL

**Cách 1: Sử dụng SOURCE trong MySQL CLI**

**Bước 1:** SSH vào EC2

```bash
ssh -i "~/.ssh/your_key.pem" ubuntu@your-ec2-public-ip
```

**Bước 2:** Đăng nhập MySQL

```bash
mysql -u root -p
```

**Bước 3:** Tạo database và import

```sql
CREATE DATABASE IF NOT EXISTS your_database_name;
USE your_database_name;
SOURCE /home/ubuntu/mysqlsampledatabase.sql;
```

**Bước 4:** Kiểm tra dữ liệu

```sql
SHOW TABLES;
SELECT * FROM table_name LIMIT 10;
```

**Cách 2: Import trực tiếp từ command line**

```bash
mysql -u root -p your_database_name < /home/ubuntu/mysqlsampledatabase.sql
```

**Giải thích:**

- `<`: Redirect operator - chuyển nội dung file thành input cho MySQL
- Nhanh hơn và phù hợp cho automation/scripts

### 8.4. Import với progress bar (cho file lớn)

```bash
# Cài đặt pv (Pipe Viewer)
sudo apt install pv -y

# Import với progress
pv /home/ubuntu/mysqlsampledatabase.sql | mysql -u root -p your_database_name
```

**Giải thích:**

- `pv`: Pipe Viewer - hiển thị progress bar khi xử lý data
- `|`: Pipe operator - chuyển output của pv làm input cho mysql

---

## 9. Các lệnh MySQL hữu ích

```bash
# Khởi động lại MySQL
sudo systemctl restart mysql

# Dừng MySQL
sudo systemctl stop mysql

# Xem log MySQL (troubleshooting)
sudo tail -f /var/log/mysql/error.log

# Kiểm tra version MySQL
mysql --version

# Kiểm tra process MySQL
ps aux | grep mysql

# Kiểm tra port 3306
sudo netstat -tuln | grep 3306
# hoặc
sudo ss -tuln | grep 3306
```

**Giải thích:**

- `ps aux`: Hiển thị tất cả processes đang chạy
  - `a`: All users
  - `u`: User-oriented format
  - `x`: Processes without controlling terminal
- `netstat`: Network statistics
  - `-t`: TCP connections
  - `-u`: UDP connections
  - `-l`: Listening sockets
  - `-n`: Numerical addresses (không resolve hostname)
- `ss`: Socket statistics (thay thế netstat, nhanh hơn)

### 9.1. Backup và Restore

**Backup database:**

```bash
mysqldump -u root -p database_name > backup_$(date +%Y%m%d).sql
```

**Giải thích:**

- `mysqldump`: Công cụ backup MySQL
- `$(date +%Y%m%d)`: Command substitution - tạo tên file theo ngày
- `>`: Redirect output ra file

**Backup tất cả databases:**

```bash
mysqldump -u root -p --all-databases > all_databases_backup.sql
```

**Restore database:**

```bash
mysql -u root -p database_name < backup_20260216.sql
```

**Backup với compression:**

```bash
# Backup và nén
mysqldump -u root -p database_name | gzip > backup.sql.gz

# Restore từ file nén
gunzip < backup.sql.gz | mysql -u root -p database_name
```

---

## 10. Security Configuration

### 10.1. Tạo user mới thay vì dùng root

**Tạo user mới:**

```sql
CREATE USER 'appuser'@'localhost' IDENTIFIED BY 'StrongPassword123!';
GRANT ALL PRIVILEGES ON your_database.* TO 'appuser'@'localhost';
FLUSH PRIVILEGES;
```

**Giải thích:**

- `CREATE USER`: Tạo user mới
- `'appuser'@'localhost'`: User chỉ kết nối từ localhost
- `GRANT ALL PRIVILEGES`: Cấp toàn quyền trên database cụ thể
- `your_database.*`: Tất cả tables trong database

**Kiểm tra quyền:**

```sql
SHOW GRANTS FOR 'appuser'@'localhost';
```

### 10.2. Cấu hình Firewall (UFW)

**UFW** (Uncomplicated Firewall) là firewall mặc định trên Ubuntu.

```bash
# Kiểm tra status UFW
sudo ufw status

# Enable UFW
sudo ufw enable

# Cho phép SSH (QUAN TRỌNG - làm trước khi enable UFW)
sudo ufw allow 22/tcp

# Cho phép MySQL từ IP cụ thể
sudo ufw allow from 203.0.113.0/24 to any port 3306

# Xem rules
sudo ufw status numbered

# Xóa rule
sudo ufw delete [rule_number]
```

**Giải thích:**

- `ufw`: Uncomplicated Firewall
- `allow 22/tcp`: Mở port 22 (SSH)
- `from 203.0.113.0/24`: Chỉ cho phép IP trong subnet này
- `to any port 3306`: Kết nối đến port 3306 (MySQL)

**⚠️ Cảnh báo:**

- **KHÔNG** chạy `sudo ufw allow 3306` (mở cho toàn bộ internet)
- Luôn giới hạn IP nguồn hoặc dùng SSH tunneling

### 10.3. Cấu hình MySQL bind-address

Mặc định MySQL chỉ lắng nghe trên localhost. Để cho phép remote connection:

**Bước 1:** Sửa file config

```bash
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

**Bước 2:** Tìm và sửa dòng

```text
# Cũ:
bind-address = 127.0.0.1

# Mới (cho phép tất cả IPs):
bind-address = 0.0.0.0

# Hoặc (cho phép IP cụ thể):
bind-address = 10.0.1.5
```

**Giải thích:**

- `bind-address`: IP mà MySQL lắng nghe kết nối
- `127.0.0.1`: Chỉ localhost (mặc định)
- `0.0.0.0`: Tất cả interfaces
- `10.0.1.5`: IP cụ thể

**Bước 3:** Khởi động lại MySQL

```bash
sudo systemctl restart mysql
```

**Bước 4:** Tạo user có thể kết nối từ xa

```sql
CREATE USER 'remote_user'@'%' IDENTIFIED BY 'StrongPass123!';
GRANT SELECT, INSERT, UPDATE ON your_database.* TO 'remote_user'@'%';
FLUSH PRIVILEGES;
```

**Giải thích:**

- `'remote_user'@'%'`: `%` = tất cả hosts (không an toàn)
- Nên dùng: `'remote_user'@'203.0.113.50'` (IP cụ thể)

---

## 11. Troubleshooting

### 11.1. MySQL không khởi động được

```bash
# Kiểm tra log lỗi
sudo tail -100 /var/log/mysql/error.log

# Kiểm tra status chi tiết
sudo systemctl status mysql -l

# Kiểm tra cấu hình file
sudo mysqld --validate-config

# Kiểm tra port có bị chiếm không
sudo netstat -tuln | grep 3306
```

**Giải thích:**

- `tail -100`: Hiển thị 100 dòng cuối của file
- `-l`: Long format (full output)
- `--validate-config`: Kiểm tra syntax config file

### 11.2. Quên mật khẩu root

```bash
# Bước 1: Dừng MySQL
sudo systemctl stop mysql

# Bước 2: Tạo init file
echo "ALTER USER 'root'@'localhost' IDENTIFIED BY 'NewPassword123!';" > /tmp/mysql-init

# Bước 3: Khởi động MySQL với init file
sudo mysqld --init-file=/tmp/mysql-init &

# Bước 4: Đợi MySQL khởi động
sleep 10

# Bước 5: Dừng process MySQL
sudo killall mysqld

# Bước 6: Xóa init file
rm /tmp/mysql-init

# Bước 7: Khởi động lại MySQL bình thường
sudo systemctl start mysql
```

**Giải thích:**

- `echo "..." > file`: Ghi text vào file
- `&`: Chạy process ở background
- `sleep 10`: Đợi 10 giây
- `killall mysqld`: Kill tất cả process tên mysqld

### 11.3. Lỗi "Access denied for user 'root'@'localhost'"

**Giải pháp 1:** Dùng sudo

```bash
sudo mysql
```

**Giải pháp 2:** Kiểm tra plugin

```sql
SELECT user, host, plugin FROM mysql.user WHERE user = 'root';
```

Nếu plugin là `auth_socket`, đổi sang `mysql_native_password` (xem phần 6.1).

### 11.4. Kiểm tra MySQL đang sử dụng bao nhiêu RAM

```bash
# Kiểm tra memory usage
ps aux | grep mysqld | awk '{print $6/1024 " MB"}'

# Hoặc dùng top
top -p $(pgrep mysqld)
```

**Giải thích:**

- `awk '{print $6/1024 " MB"}'`: Awk script để tính toán
  - `$6`: Cột thứ 6 (memory trong KB)
  - `/1024`: Chia cho 1024 để ra MB
- `pgrep mysqld`: Tìm PID của process mysqld
- `top -p <PID>`: Hiển thị thông tin process cụ thể

---

## 12. So sánh lệnh Ubuntu vs Amazon Linux

| Task | Ubuntu | Amazon Linux |
| --- | --- | --- |
| Cài đặt package | `apt install package` | `yum install package` |
| Cập nhật package list | `apt update` | `yum check-update` |
| Nâng cấp packages | `apt upgrade` | `yum update` |
| Tìm kiếm package | `apt search keyword` | `yum search keyword` |
| Xóa package | `apt remove package` | `yum remove package` |
| Xóa package + config | `apt purge package` | `yum remove package` |
| List installed packages | `apt list --installed` | `yum list installed` |
| MySQL service name | `mysql` | `mysqld` |
| Default user | `ubuntu` | `ec2-user` |
| Log location | `/var/log/mysql/` | `/var/log/mysqld.log` |
| Firewall | `ufw` | `firewall-cmd` / `iptables` |

---

## 13. Best Practices

### 13.1. Security

- ✅ Luôn chạy `mysql_secure_installation`
- ✅ Tạo user riêng cho từng application, không dùng root
- ✅ Sử dụng password mạnh (chữ hoa, chữ thường, số, ký tự đặc biệt)
- ✅ Giới hạn remote access bằng IP whitelist
- ✅ Sử dụng SSH tunneling thay vì mở port 3306 ra internet
- ✅ Thường xuyên backup database

### 13.2. Performance

- ✅ Cấu hình `innodb_buffer_pool_size` = 70-80% RAM
- ✅ Enable slow query log để tìm queries chậm
- ✅ Sử dụng indexes hợp lý
- ✅ Monitor disk I/O và CPU usage

### 13.3. Backup

- ✅ Tự động backup hàng ngày với cron job
- ✅ Lưu backup ở nơi khác (S3, external server)
- ✅ Thường xuyên test restore process
- ✅ Backup cả schema và data

**Ví dụ cron job cho backup tự động:**

```bash
# Mở crontab editor
crontab -e

# Thêm dòng: Backup mỗi ngày lúc 2:00 AM
0 2 * * * /usr/bin/mysqldump -u root -pYourPassword database_name > /backups/backup_$(date +\%Y\%m\%d).sql 2>&1
```

**Giải thích cron syntax:**

- `0 2 * * *`: Minute Hour Day Month Weekday
  - `0`: Phút 0
  - `2`: Giờ 2 (2 AM)
  - `* * *`: Mọi ngày, mọi tháng, mọi tuần
- `2>&1`: Redirect stderr (2) vào stdout (1)

---

## 14. Monitoring và Logging

### 14.1. Enable slow query log

```bash
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
```

Thêm:

```text
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2
```

**Giải thích:**

- `slow_query_log = 1`: Enable slow query logging
- `long_query_time = 2`: Log queries mất hơn 2 giây

**Xem slow queries:**

```bash
sudo tail -f /var/log/mysql/slow-query.log
```

### 14.2. Enable general query log (development only)

**⚠️ Cảnh báo:** Không nên enable trên production (rất tốn disk)

```sql
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/log/mysql/general.log';
```

**Tắt:**

```sql
SET GLOBAL general_log = 'OFF';
```

---

## Tham khảo

- [MySQL Official Documentation](https://dev.mysql.com/doc/)
- [Ubuntu Server Guide - MySQL](https://ubuntu.com/server/docs/databases-mysql)
- [AWS EC2 User Guide](https://docs.aws.amazon.com/ec2/)
- [DigitalOcean MySQL Tutorials](https://www.digitalocean.com/community/tags/mysql)
