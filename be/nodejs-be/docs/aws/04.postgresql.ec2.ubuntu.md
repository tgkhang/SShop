# Hướng dẫn cài đặt PostgreSQL trên AWS EC2 Instance (Ubuntu)

> **Lưu ý**: File này hướng dẫn cài đặt PostgreSQL Server trên Ubuntu EC2 instance.

## Tổng quan

**PostgreSQL** là hệ quản trị cơ sở dữ liệu quan hệ mã nguồn mở, mạnh mẽ và phổ biến. PostgreSQL hỗ trợ:

- ✅ ACID compliance (Atomicity, Consistency, Isolation, Durability)
- ✅ JSON/JSONB data types (NoSQL features)
- ✅ Full-text search
- ✅ Advanced indexing (GiST, GIN, BRIN, etc.)
- ✅ Foreign Data Wrappers (FDW)
- ✅ Extensibility (custom types, functions, operators)

---

## 1. So sánh PostgreSQL vs MySQL

| Đặc điểm | PostgreSQL | MySQL |
| --- | --- | --- |
| Licence | PostgreSQL License (MIT-style) | GPL hoặc Commercial |
| ACID | Full ACID compliance | ACID với InnoDB |
| JSON Support | Native JSON + JSONB (binary) | JSON (từ 5.7+) |
| Full-text Search | Built-in, powerful | Basic, cần sử dụng external tools |
| Replication | Streaming, logical | Async, semi-sync, group |
| Extensibility | Rất cao (extensions, custom types) | Giới hạn hơn |
| Performance | Tốt cho complex queries | Tốt cho simple read-heavy |
| Use Cases | Analytics, GIS, complex apps | Web apps, simple CRUD |

---

## 2. Cập nhật hệ thống

### 2.1. Cập nhật package list

```bash
sudo apt update
```

**Giải thích:**

- `apt update`: Cập nhật danh sách packages từ repositories
- **Lưu ý**: Lệnh này KHÔNG cài đặt hay nâng cấp gì, chỉ refresh metadata

### 2.2. Nâng cấp packages hiện có (Optional nhưng khuyến nghị)

```bash
sudo apt upgrade -y
```

**Giải thích:**

- `apt upgrade`: Nâng cấp tất cả packages đã cài lên phiên bản mới nhất
- `-y`: Auto confirm tất cả prompts

---

## 3. Cài đặt PostgreSQL

### 3.1. Cài đặt từ Ubuntu Default Repository

**Cách 1: Cài phiên bản có sẵn trong Ubuntu repo (Đơn giản nhất)**

```bash
sudo apt install postgresql postgresql-contrib -y
```

**Giải thích:**

- `postgresql`: Package chính chứa PostgreSQL Server
- `postgresql-contrib`: Additional utilities và extensions (hstore, pg_trgm, etc.)
- `-y`: Auto confirm

**Kiểm tra version:**

```bash
psql --version
```

### 3.2. Cài đặt phiên bản mới nhất từ PostgreSQL Official Repository (Khuyến nghị)

Ubuntu repository thường chứa phiên bản PostgreSQL cũ hơn. Để cài phiên bản mới nhất:

**Bước 1: Thêm PostgreSQL APT Repository**

```bash
# Import repository signing key
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
```

**Giải thích:**

- `wget --quiet -O -`: Download file và output ra stdout (không lưu file)
  - `--quiet`: Không hiển thị progress bar
  - `-O -`: Output to stdout (dấu `-` nghĩa là stdout)
- `|`: Pipe output sang lệnh tiếp theo
- `sudo apt-key add -`: Thêm GPG key vào APT keyring để verify packages

**Bước 2: Thêm repository vào sources list**

```bash
# Tạo file repository config
echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
```

**Giải thích:**

- `$(lsb_release -cs)`: Command substitution - lấy codename của Ubuntu (focal, jammy, etc.)
  - `lsb_release`: Linux Standard Base Release info
  - `-cs`: Codename short (vd: "jammy" cho Ubuntu 22.04)
- `echo "..." | sudo tee file`: Ghi text vào file với quyền sudo
  - `tee`: Đọc từ stdin và ghi ra file (và stdout)
  - Dùng `tee` thay vì `>` vì `>` không hoạt động với sudo

**Bước 3: Cập nhật package list và cài đặt**

```bash
sudo apt update
sudo apt install postgresql postgresql-contrib -y
```

**Kiểm tra version sau khi cài:**

```bash
psql --version
# Output ví dụ: psql (PostgreSQL) 16.1
```

---

## 4. Khởi động và quản lý PostgreSQL Service

### 4.1. Về systemctl

**systemctl** quản lý services sử dụng systemd:

| Lệnh | Mô tả |
| --- | --- |
| `systemctl start <service>` | Khởi động service |
| `systemctl stop <service>` | Dừng service |
| `systemctl restart <service>` | Khởi động lại service |
| `systemctl status <service>` | Xem trạng thái service |
| `systemctl enable <service>` | Auto-start khi boot |
| `systemctl reload <service>` | Reload config không restart |

### 4.2. Kiểm tra trạng thái PostgreSQL

```bash
# Kiểm tra status
sudo systemctl status postgresql

# Hoặc kiểm tra cụ thể version
sudo systemctl status postgresql@16-main
```

**Giải thích:**

- Service name format: `postgresql@<version>-<cluster>`
- Cluster mặc định: `main`
- PostgreSQL tự động start sau khi cài đặt

### 4.3. Quản lý PostgreSQL service

```bash
# Khởi động PostgreSQL
sudo systemctl start postgresql

# Dừng PostgreSQL
sudo systemctl stop postgresql

# Khởi động lại
sudo systemctl restart postgresql

# Enable auto-start khi reboot
sudo systemctl enable postgresql

# Reload config (không restart)
sudo systemctl reload postgresql
```

**Kiểm tra PostgreSQL đã chạy chưa:**

```bash
# Kiểm tra process
ps aux | grep postgres

# Kiểm tra port 5432
sudo ss -tuln | grep 5432
```

**Giải thích:**

- PostgreSQL mặc định listen trên port **5432**
- `ss`: Socket statistics (thay thế `netstat`, nhanh hơn)
  - `-t`: TCP
  - `-u`: UDP
  - `-l`: Listening sockets
  - `-n`: Numeric (không resolve hostname)

---

## 5. Kết nối PostgreSQL lần đầu

### 5.1. Về User và Authentication

**Sự khác biệt quan trọng giữa PostgreSQL và MySQL:**

| Đặc điểm | PostgreSQL | MySQL |
| --- | --- | --- |
| Default admin user | `postgres` | `root` |
| Default auth method | `peer` (local) | Password hoặc auth_socket |
| Default password | KHÔNG CÓ | Temporary password hoặc empty |

**Về Peer Authentication:**

- PostgreSQL sử dụng `peer authentication` cho local connections
- OS user `postgres` có thể đăng nhập DB user `postgres` KHÔNG CẦN MẬT KHẨU
- Chỉ hoạt động khi connect qua Unix socket (local)

### 5.2. Đăng nhập PostgreSQL lần đầu

**Cách 1: Switch sang postgres user và kết nối**

```bash
# Switch sang postgres OS user
sudo -i -u postgres

# Kết nối PostgreSQL
psql
```

**Giải thích:**

- `sudo -i -u postgres`: Login shell với user postgres
  - `-i`: Interactive login shell
  - `-u postgres`: User postgres
- `psql`: PostgreSQL interactive terminal

**Cách 2: Chạy psql trực tiếp với sudo (Nhanh hơn)**

```bash
sudo -u postgres psql
```

**Giải thích:**

- `sudo -u postgres psql`: Chạy psql với user postgres (không switch shell)

### 5.3. Các lệnh psql cơ bản

Sau khi vào psql prompt (`postgres=#`):

```sql
-- Liệt kê databases
\l

-- Liệt kê users/roles
\du

-- Kết nối database khác
\c database_name

-- Liệt kê tables trong database hiện tại
\dt

-- Liệt kê schemas
\dn

-- Xem thông tin table
\d table_name

-- Thoát psql
\q
-- hoặc
exit
```

**Giải thích:**

- `\` commands: Meta-commands của psql (không phải SQL)
- `;` không cần thiết cho meta-commands
- SQL queries PHẢI kết thúc bằng `;`

---

## 6. Đặt mật khẩu cho postgres user

### 6.1. Đặt mật khẩu trong psql

**Bước 1: Kết nối psql**

```bash
sudo -u postgres psql
```

**Bước 2: Đặt mật khẩu cho postgres user**

```sql
ALTER USER postgres WITH PASSWORD 'YourStrongPassword123!';
```

**Giải thích:**

- `ALTER USER`: Thay đổi thuộc tính của user/role
- `postgres`: Tên user (default superuser)
- `WITH PASSWORD '...'`: Set password mới

**Bước 3: Thoát psql**

```sql
\q
```

### 6.2. Cấu hình Password Authentication

Mặc định PostgreSQL dùng `peer` auth cho local và `md5` hoặc `scram-sha-256` cho remote.

**Xem cấu hình hiện tại:**

```bash
sudo cat /etc/postgresql/*/main/pg_hba.conf
```

**Giải thích về `pg_hba.conf`:**

- **HBA**: Host-Based Authentication
- File này định nghĩa: ai có thể connect, từ đâu, vào database nào, dùng auth method gì
- Format: `TYPE  DATABASE  USER  ADDRESS  METHOD`

**Ví dụ nội dung:**

```text
# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             postgres                                peer
local   all             all                                     peer
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             ::1/128                 scram-sha-256
```

**Giải thích:**

- `local`: Unix socket connection
- `host`: TCP/IP connection
- `peer`: OS user authentication (chỉ local)
- `md5`: Password hashed với MD5 (deprecated)
- `scram-sha-256`: Password hashed với SCRAM-SHA-256 (khuyến nghị)

**Thay đổi để cho phép password auth cho local:**

```bash
# Backup file gốc
sudo cp /etc/postgresql/*/main/pg_hba.conf /etc/postgresql/*/main/pg_hba.conf.bak

# Edit file
sudo nano /etc/postgresql/*/main/pg_hba.conf
```

**Thay đổi dòng:**

```text
# Cũ:
local   all             postgres                                peer

# Mới:
local   all             postgres                                scram-sha-256
```

**Reload config để áp dụng:**

```bash
sudo systemctl reload postgresql
```

**Bây giờ kết nối cần mật khẩu:**

```bash
psql -U postgres -d postgres
# Sẽ hỏi password
```

**Giải thích:**

- `-U postgres`: Username
- `-d postgres`: Database name
- Nếu không specify `-d`, mặc định là database trùng tên user

---

## 7. Tạo User và Database mới

### 7.1. Tạo database user

```bash
# Kết nối với postgres superuser
sudo -u postgres psql
```

```sql
-- Tạo user mới
CREATE USER myapp_user WITH PASSWORD 'SecurePassword123!';

-- Tạo user với nhiều options
CREATE USER app_admin WITH
  PASSWORD 'AdminPass123!'
  CREATEDB
  CREATEROLE;
```

**Giải thích:**

- `CREATE USER`: Tạo user mới (alias của `CREATE ROLE ... WITH LOGIN`)
- `WITH PASSWORD '...'`: Set password
- `CREATEDB`: Cho phép user tạo databases
- `CREATEROLE`: Cho phép user tạo roles khác

### 7.2. Tạo database

```sql
-- Tạo database đơn giản
CREATE DATABASE myapp_db;

-- Tạo database với owner cụ thể
CREATE DATABASE myapp_db OWNER myapp_user;

-- Tạo database với encoding và locale
CREATE DATABASE myapp_db
  OWNER myapp_user
  ENCODING 'UTF8'
  LC_COLLATE 'en_US.UTF-8'
  LC_CTYPE 'en_US.UTF-8';
```

**Giải thích:**

- `OWNER`: User sở hữu database
- `ENCODING 'UTF8'`: Character encoding (UTF-8 khuyến nghị)
- `LC_COLLATE`: Thứ tự sắp xếp string
- `LC_CTYPE`: Phân loại ký tự

### 7.3. Cấp quyền cho user

```sql
-- Cấp tất cả quyền trên database
GRANT ALL PRIVILEGES ON DATABASE myapp_db TO myapp_user;

-- Kết nối database
\c myapp_db

-- Cấp quyền trên schema public
GRANT ALL PRIVILEGES ON SCHEMA public TO myapp_user;

-- Cấp quyền trên tất cả tables hiện tại
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO myapp_user;

-- Cấp quyền trên tất cả sequences
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO myapp_user;

-- Cấp quyền mặc định cho tables tương lai
ALTER DEFAULT PRIVILEGES IN SCHEMA public
  GRANT ALL PRIVILEGES ON TABLES TO myapp_user;
```

**Giải thích:**

- `GRANT`: Cấp quyền
- `ON DATABASE`: Quyền cấp độ database
- `ON SCHEMA`: Quyền cấp độ schema
- `ON ALL TABLES`: Quyền trên tất cả tables hiện có
- `ALTER DEFAULT PRIVILEGES`: Quyền mặc định cho objects mới

**Các quyền cụ thể:**

- `SELECT`: Đọc dữ liệu
- `INSERT`: Thêm dữ liệu
- `UPDATE`: Sửa dữ liệu
- `DELETE`: Xóa dữ liệu
- `TRUNCATE`: Xóa toàn bộ table
- `REFERENCES`: Tạo foreign keys
- `TRIGGER`: Tạo triggers
- `ALL PRIVILEGES`: Tất cả quyền trên

### 7.4. Kiểm tra users và databases

```sql
-- Liệt kê users/roles
\du

-- Liệt kê databases
\l

-- Xem quyền của user trên database
\l+ myapp_db

-- Kết nối database
\c myapp_db

-- Xem quyền trên tables
\dp
-- hoặc
\z
```

---

## 8. Import dữ liệu từ file SQL

### 8.1. Chuẩn bị file SQL

Giả sử bạn có file `sample_data.sql` trên máy local.

### 8.2. Copy file SQL từ local lên EC2

```bash
scp -i "~/.ssh/your_key.pem" /path/to/sample_data.sql ubuntu@your-ec2-public-ip:~/
```

**Giải thích:**

- `scp`: Secure copy qua SSH
- `-i "~/.ssh/your_key.pem"`: Private key
- `ubuntu`: Default username cho Ubuntu EC2 instance
- `:~/`: Home directory trên server (`/home/ubuntu/`)

### 8.3. Import file SQL vào PostgreSQL

**Cách 1: Sử dụng psql với redirect**

```bash
# SSH vào EC2
ssh -i "~/.ssh/your_key.pem" ubuntu@your-ec2-public-ip

# Import vào database
sudo -u postgres psql -d myapp_db -f /home/ubuntu/sample_data.sql
```

**Giải thích:**

- `-d myapp_db`: Target database
- `-f file.sql`: Execute commands từ file

**Cách 2: Redirect input**

```bash
sudo -u postgres psql myapp_db < /home/ubuntu/sample_data.sql
```

**Cách 3: Sử dụng \i trong psql**

```bash
# Kết nối database
sudo -u postgres psql -d myapp_db
```

```sql
-- Import file
\i /home/ubuntu/sample_data.sql
```

**Cách 4: Import với user thường (không phải postgres)**

```bash
# Nếu đã tạo user myapp_user
psql -U myapp_user -d myapp_db -h localhost -f /home/ubuntu/sample_data.sql
```

**Giải thích:**

- `-h localhost`: Specify host (force TCP connection thay vì Unix socket)
- Sẽ hỏi password của myapp_user

### 8.4. Import với progress (cho file lớn)

```bash
# Cài pv (Pipe Viewer)
sudo apt install pv -y

# Import với progress bar
pv /home/ubuntu/sample_data.sql | sudo -u postgres psql -d myapp_db
```

**Giải thích:**

- `pv`: Hiển thị progress bar khi xử lý data qua pipe
- Shows: bytes processed, time elapsed, ETA, throughput

---

## 9. Backup và Restore

### 9.1. Về pg_dump và pg_restore

**pg_dump**: Backup PostgreSQL database

- Tạo file SQL script hoặc archive format
- Backup logical (không phải physical copy)
- Có thể backup selective (tables, schemas, etc.)

**pg_restore**: Restore từ archive format

- Chỉ dùng với non-plain-text formats
- Hỗ trợ parallel restore
- Có thể restore selective

### 9.2. Backup Database

**Format 1: Plain SQL (human-readable)**

```bash
# Backup database thành SQL script
sudo -u postgres pg_dump myapp_db > backup_$(date +%Y%m%d).sql

# Backup với compression
sudo -u postgres pg_dump myapp_db | gzip > backup_$(date +%Y%m%d).sql.gz
```

**Giải thích:**

- `pg_dump`: PostgreSQL dump utility
- `$(date +%Y%m%d)`: Tạo tên file theo ngày (20260216)
- `| gzip`: Pipe output qua gzip để nén

**Format 2: Custom format (khuyến nghị cho large databases)**

```bash
# Backup với custom format (nén, hỗ trợ parallel restore)
sudo -u postgres pg_dump -Fc myapp_db -f backup_custom.dump

# Backup với directory format (parallel dump)
sudo -u postgres pg_dump -Fd myapp_db -f backup_dir -j 4
```

**Giải thích:**

- `-Fc`: Custom format (compressed, flexible)
- `-Fd`: Directory format (multiple files, parallel)
- `-f filename`: Output file
- `-j 4`: 4 parallel jobs (chỉ với directory format)

**Backup tất cả databases:**

```bash
sudo -u postgres pg_dumpall > all_databases_backup.sql
```

**Giải thích:**

- `pg_dumpall`: Backup tất cả databases + globals (users, roles)
- **Lưu ý**: Chỉ hỗ trợ plain SQL format

### 9.3. Restore Database

**Restore từ plain SQL:**

```bash
# Tạo database trước
sudo -u postgres createdb myapp_db_restored

# Restore
sudo -u postgres psql -d myapp_db_restored -f backup_20260216.sql

# Hoặc từ gzip
gunzip -c backup_20260216.sql.gz | sudo -u postgres psql -d myapp_db_restored
```

**Restore từ custom format:**

```bash
# Tạo database
sudo -u postgres createdb myapp_db_restored

# Restore
sudo -u postgres pg_restore -d myapp_db_restored backup_custom.dump

# Restore với parallel jobs
sudo -u postgres pg_restore -d myapp_db_restored -j 4 backup_custom.dump
```

**Giải thích:**

- `createdb`: Utility tạo database (thay vì vào psql)
- `pg_restore`: Restore từ non-plain formats
- `-j 4`: 4 parallel jobs (nhanh hơn cho large databases)

**Restore chỉ một table:**

```bash
sudo -u postgres pg_restore -d myapp_db -t users backup_custom.dump
```

### 9.4. Automated Backup với Cron

**Tạo backup script:**

```bash
# Tạo script
sudo nano /usr/local/bin/pg_backup.sh
```

**Nội dung script:**

```bash
#!/bin/bash

# Configuration
BACKUP_DIR="/backups/postgresql"
DB_NAME="myapp_db"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# Create backup directory
mkdir -p $BACKUP_DIR

# Perform backup
su - postgres -c "pg_dump -Fc $DB_NAME -f $BACKUP_DIR/${DB_NAME}_${DATE}.dump"

# Delete old backups
find $BACKUP_DIR -name "${DB_NAME}_*.dump" -mtime +$RETENTION_DAYS -delete

# Log
echo "Backup completed: ${DB_NAME}_${DATE}.dump"
```

**Giải thích:**

- `#!/bin/bash`: Shebang - chỉ định shell
- `mkdir -p`: Tạo directory, `-p` = không lỗi nếu đã tồn tại
- `su - postgres -c "..."`: Run command as postgres user
- `find ... -mtime +7 -delete`: Xóa files cũ hơn 7 ngày

**Cấp quyền thực thi:**

```bash
sudo chmod +x /usr/local/bin/pg_backup.sh
```

**Giải thích:**

- `chmod +x`: Add execute permission
- `+x`: Thêm permission x (execute) cho tất cả (user, group, others)

**Tạo cron job:**

```bash
# Edit crontab
sudo crontab -e
```

**Thêm dòng (backup mỗi ngày lúc 2:00 AM):**

```text
0 2 * * * /usr/local/bin/pg_backup.sh >> /var/log/pg_backup.log 2>&1
```

**Giải thích cron syntax:**

```text
* * * * *  command
│ │ │ │ │
│ │ │ │ └─── Weekday (0-7, 0 và 7 = Sunday)
│ │ │ └───── Month (1-12)
│ │ └─────── Day of month (1-31)
│ └───────── Hour (0-23)
└─────────── Minute (0-59)
```

- `0 2 * * *`: Lúc 2:00 AM mỗi ngày
- `>>`: Append output vào file
- `2>&1`: Redirect stderr (2) vào stdout (1)

---

## 10. Cấu hình Remote Access

### 10.1. Cấu hình PostgreSQL listen trên tất cả interfaces

Mặc định PostgreSQL chỉ listen trên localhost.

**Edit postgresql.conf:**

```bash
# Tìm file config
sudo find /etc/postgresql -name postgresql.conf

# Edit (thay * bằng version thực tế, vd: 16)
sudo nano /etc/postgresql/*/main/postgresql.conf
```

**Tìm và sửa dòng:**

```text
# Cũ:
#listen_addresses = 'localhost'

# Mới (listen tất cả IPs):
listen_addresses = '*'

# Hoặc (listen IP cụ thể):
listen_addresses = 'localhost,10.0.1.5'
```

**Giải thích:**

- `listen_addresses`: IP addresses PostgreSQL lắng nghe kết nối
- `'localhost'`: Chỉ local connections
- `'*'`: Tất cả interfaces
- `'localhost,10.0.1.5'`: Multiple IPs (comma-separated)

### 10.2. Cấu hình pg_hba.conf cho remote connections

```bash
sudo nano /etc/postgresql/*/main/pg_hba.conf
```

**Thêm dòng:**

```text
# Allow connections from specific IP
host    all             all             203.0.113.50/32         scram-sha-256

# Allow connections from subnet
host    all             all             10.0.0.0/24             scram-sha-256

# Allow all IPs (KHÔNG AN TOÀN - chỉ dùng test)
host    all             all             0.0.0.0/0               scram-sha-256
```

**Giải thích:**

- `host`: TCP/IP connection
- `all` (database): Tất cả databases
- `all` (user): Tất cả users
- `203.0.113.50/32`: Specific IP (CIDR notation, /32 = single IP)
- `10.0.0.0/24`: Subnet (256 IPs: 10.0.0.0 - 10.0.0.255)
- `0.0.0.0/0`: Tất cả IPs (mọi nguồn)
- `scram-sha-256`: Authentication method

### 10.3. Restart PostgreSQL

```bash
sudo systemctl restart postgresql
```

### 10.4. Cấu hình UFW Firewall

```bash
# Kiểm tra UFW status
sudo ufw status

# Enable UFW (nếu chưa)
sudo ufw enable

# QUAN TRỌNG: Allow SSH trước khi enable UFW
sudo ufw allow 22/tcp

# Allow PostgreSQL từ IP cụ thể
sudo ufw allow from 203.0.113.50 to any port 5432

# Allow PostgreSQL từ subnet
sudo ufw allow from 10.0.0.0/24 to any port 5432

# Xem rules
sudo ufw status numbered

# Xóa rule
sudo ufw delete [rule_number]
```

**Giải thích:**

- `ufw`: Uncomplicated Firewall
- `allow from ... to any port 5432`: Cho phép kết nối từ IP/subnet đến port 5432
- **⚠️ Cảnh báo**: KHÔNG chạy `sudo ufw allow 5432` (mở cho toàn internet)

### 10.5. Cấu hình AWS Security Group

Trên AWS Console:

1. EC2 → Security Groups
2. Chọn security group của instance
3. Inbound rules → Edit
4. Add rule:
   - Type: **Custom TCP**
   - Port: **5432**
   - Source: **My IP** hoặc IP cụ thể
5. Save

### 10.6. Test remote connection

Từ máy local:

```bash
psql -h your-ec2-public-ip -U myapp_user -d myapp_db
```

**Giải thích:**

- `-h`: Hostname/IP
- `-U`: Username
- `-d`: Database
- Sẽ hỏi password

---

## 11. Tối ưu hóa Performance

### 11.1. Cấu hình Memory

Edit `postgresql.conf`:

```bash
sudo nano /etc/postgresql/*/main/postgresql.conf
```

**Các tham số quan trọng:**

```text
# Shared buffers (25% RAM, max 8GB cho production)
shared_buffers = 2GB

# Effective cache size (50-75% RAM)
effective_cache_size = 6GB

# Maintenance work mem (cho VACUUM, CREATE INDEX)
maintenance_work_mem = 512MB

# Work mem (cho sorting, hashing mỗi query)
work_mem = 16MB

# WAL buffers
wal_buffers = 16MB
```

**Giải thích:**

- `shared_buffers`: Memory cache PostgreSQL dùng cho data pages
  - **Rule of thumb**: 25% RAM, không quá 8GB
  - VD: Server 8GB RAM → 2GB shared_buffers
- `effective_cache_size`: Estimate của OS cache + shared_buffers
  - Không allocate memory, chỉ hint cho query planner
  - **Rule of thumb**: 50-75% tổng RAM
- `maintenance_work_mem`: Memory cho maintenance operations
  - VACUUM, CREATE INDEX, ALTER TABLE
  - **Rule of thumb**: 10% RAM, max 1-2GB
- `work_mem`: Memory per operation (sort, hash)
  - **Cẩn thận**: Mỗi query có thể dùng nhiều operations
  - VD: 100 connections × 5 sorts × 16MB = 8GB!
  - **Rule of thumb**: `(RAM * 0.25) / max_connections / 2`

### 11.2. Cấu hình Connections

```text
# Maximum connections
max_connections = 100

# Reserved connections cho superuser
superuser_reserved_connections = 3
```

**Giải thích:**

- `max_connections`: Số kết nối tối đa
  - **Lưu ý**: Mỗi connection tốn ~10MB RAM
  - Nên dùng connection pooler (PgBouncer) thay vì tăng max_connections
- `superuser_reserved_connections`: Reserved cho admin khi db đầy

### 11.3. Cấu hình WAL (Write-Ahead Logging)

```text
# Checkpoint settings
checkpoint_completion_target = 0.9
wal_buffers = 16MB
min_wal_size = 1GB
max_wal_size = 4GB
```

**Giải thích:**

- **WAL**: Write-Ahead Log - ghi log trước khi commit
- `checkpoint_completion_target`: Spread checkpoint I/O
  - 0.9 = spread over 90% của checkpoint interval
- `min_wal_size`, `max_wal_size`: WAL file size limits

### 11.4. Apply changes và restart

```bash
sudo systemctl restart postgresql
```

**Kiểm tra config hiện tại:**

```sql
-- Connect psql
sudo -u postgres psql

-- Xem setting
SHOW shared_buffers;
SHOW effective_cache_size;
SHOW work_mem;

-- Xem tất cả settings
SELECT name, setting, unit, short_desc
FROM pg_settings
WHERE name IN ('shared_buffers', 'effective_cache_size', 'work_mem');
```

---

## 12. Monitoring và Logging

### 12.1. Enable logging

Edit `postgresql.conf`:

```text
# Logging configuration
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# What to log
log_min_duration_statement = 1000  # Log queries > 1 second
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
log_autovacuum_min_duration = 0
```

**Giải thích:**

- `logging_collector`: Enable log collector process
- `log_filename`: Log filename pattern
  - `%Y`: Year, `%m`: Month, `%d`: Day
  - `%H`: Hour, `%M`: Minute, `%S`: Second
- `log_rotation_age`: Rotate log sau 1 ngày
- `log_rotation_size`: Rotate log khi đạt 100MB
- `log_min_duration_statement`: Log slow queries (> 1000ms = 1s)
- `log_line_prefix`: Format của mỗi log line
  - `%t`: Timestamp, `%p`: PID, `%u`: User
  - `%d`: Database, `%a`: Application, `%h`: Client host
- `log_checkpoints`: Log checkpoint activity
- `log_connections`: Log khi có connection
- `log_disconnections`: Log khi disconnect
- `log_lock_waits`: Log khi query bị lock
- `log_temp_files`: Log temp files (0 = log all)
- `log_autovacuum_min_duration`: Log autovacuum (0 = log all)

### 12.2. Xem logs

```bash
# Xem log real-time
sudo tail -f /var/log/postgresql/postgresql-*.log

# Xem log với filter
sudo grep "ERROR" /var/log/postgresql/postgresql-*.log

# Xem log của ngày hôm nay
sudo tail -100 /var/log/postgresql/postgresql-$(date +%Y-%m-%d)*.log
```

### 12.3. Monitoring queries

```sql
-- Xem active queries
SELECT pid, usename, application_name, client_addr, state, query, query_start
FROM pg_stat_activity
WHERE state != 'idle';

-- Kill query đang chạy
SELECT pg_terminate_backend(pid);

-- Xem slow queries (cần pg_stat_statements extension)
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

SELECT query, calls, total_exec_time, mean_exec_time, max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

**Giải thích:**

- `pg_stat_activity`: View hiển thị thông tin các connections
- `pg_terminate_backend(pid)`: Kill process/query
- `pg_stat_statements`: Extension track query statistics

---

## 13. Security Best Practices

### 13.1. Checklist bảo mật

- ✅ Đặt mật khẩu mạnh cho postgres user
- ✅ Tạo users riêng cho từng application (không dùng postgres user)
- ✅ Sử dụng `scram-sha-256` thay vì `md5`
- ✅ Giới hạn remote access bằng IP whitelist trong pg_hba.conf
- ✅ Sử dụng SSL/TLS cho remote connections
- ✅ Cấu hình firewall (UFW + AWS Security Group)
- ✅ Regular backups với encryption
- ✅ Monitor logs cho suspicious activity
- ✅ Keep PostgreSQL updated
- ✅ Principle of least privilege (cấp quyền tối thiểu)

### 13.2. Enable SSL/TLS

**Generate self-signed certificate (cho testing):**

```bash
# Switch to postgres user
sudo -u postgres -i

# Generate certificate
openssl req -new -x509 -days 365 -nodes -text \
  -out /var/lib/postgresql/*/main/server.crt \
  -keyout /var/lib/postgresql/*/main/server.key \
  -subj "/CN=postgresql-server"

# Set permissions
chmod 600 /var/lib/postgresql/*/main/server.key
exit
```

**Giải thích:**

- `openssl req`: Certificate request utility
- `-new -x509`: Tạo self-signed cert
- `-days 365`: Valid 1 năm
- `-nodes`: No passphrase
- `-out`: Output cert file
- `-keyout`: Output private key
- `chmod 600`: Read/write chỉ owner

**Edit postgresql.conf:**

```text
ssl = on
ssl_cert_file = '/var/lib/postgresql/16/main/server.crt'
ssl_key_file = '/var/lib/postgresql/16/main/server.key'
```

**Restart PostgreSQL:**

```bash
sudo systemctl restart postgresql
```

**Force SSL trong pg_hba.conf:**

```text
# Require SSL
hostssl    all             all             0.0.0.0/0               scram-sha-256
```

**Giải thích:**

- `hostssl`: Chỉ cho phép SSL connections
- `host`: Cho phép cả SSL và non-SSL

**Connect với SSL:**

```bash
psql "host=your-server dbname=mydb user=myuser sslmode=require"
```

**SSL modes:**

- `disable`: No SSL
- `allow`: SSL nếu server hỗ trợ
- `prefer`: Prefer SSL (default)
- `require`: Require SSL
- `verify-ca`: Require SSL + verify CA
- `verify-full`: Require SSL + verify CA + verify hostname

---

## 14. Các lệnh PostgreSQL hữu ích

### 14.1. Database management

```bash
# Tạo database
sudo -u postgres createdb database_name

# Xóa database
sudo -u postgres dropdb database_name

# Tạo user
sudo -u postgres createuser username

# Xóa user
sudo -u postgres dropuser username
```

### 14.2. Maintenance

```sql
-- Vacuum (cleanup dead rows)
VACUUM;

-- Vacuum analyze (cleanup + update statistics)
VACUUM ANALYZE;

-- Vacuum full (reclaim space, locks table)
VACUUM FULL;

-- Reindex
REINDEX DATABASE database_name;
REINDEX TABLE table_name;

-- Analyze (update statistics)
ANALYZE;
ANALYZE table_name;
```

**Giải thích:**

- `VACUUM`: PostgreSQL MVCC tạo dead rows, VACUUM cleanup
- `VACUUM ANALYZE`: VACUUM + update statistics cho query planner
- `VACUUM FULL`: Reclaim disk space (locks table, slow)
- `REINDEX`: Rebuild indexes (fix bloat, corruption)
- `ANALYZE`: Update statistics (không cleanup)

### 14.3. Information queries

```sql
-- Database size
SELECT pg_size_pretty(pg_database_size('database_name'));

-- Table size
SELECT pg_size_pretty(pg_total_relation_size('table_name'));

-- Top 10 largest tables
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
LIMIT 10;

-- Index usage
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes
ORDER BY idx_scan ASC;
```

---

## 15. Troubleshooting

### 15.1. PostgreSQL không khởi động

```bash
# Kiểm tra log
sudo tail -100 /var/log/postgresql/postgresql-*.log

# Kiểm tra status
sudo systemctl status postgresql -l

# Kiểm tra config syntax
sudo -u postgres postgres -C config_file

# Kiểm tra port có bị chiếm không
sudo ss -tuln | grep 5432
```

### 15.2. Connection refused

**Kiểm tra:**

1. PostgreSQL có đang chạy không?

   ```bash
   sudo systemctl status postgresql
   ```

2. `listen_addresses` đúng chưa?

   ```bash
   sudo grep listen_addresses /etc/postgresql/*/main/postgresql.conf
   ```

3. Firewall có block không?

   ```bash
   sudo ufw status
   ```

4. `pg_hba.conf` có allow connection không?

   ```bash
   sudo cat /etc/postgresql/*/main/pg_hba.conf
   ```

### 15.3. Too many connections

**Kiểm tra connections hiện tại:**

```sql
SELECT count(*) FROM pg_stat_activity;
```

**Xem connection limit:**

```sql
SHOW max_connections;
```

**Giải pháp:**

1. Kill idle connections:

   ```sql
   SELECT pg_terminate_backend(pid)
   FROM pg_stat_activity
   WHERE state = 'idle'
   AND state_change < now() - interval '10 minutes';
   ```

2. Tăng max_connections (trong postgresql.conf)
3. Sử dụng connection pooler (PgBouncer)

### 15.4. Disk full

**Kiểm tra disk usage:**

```bash
df -h
```

**Kiểm tra PostgreSQL data size:**

```bash
sudo du -sh /var/lib/postgresql/*/main
```

**Giải pháp:**

1. VACUUM FULL để reclaim space
2. Xóa old WAL files (nếu archive mode off)
3. Drop unused indexes
4. Archive old data

---

## 16. PostgreSQL Extensions hữu ích

### 16.1. Cài đặt extension

```sql
-- List available extensions
SELECT * FROM pg_available_extensions;

-- Install extension
CREATE EXTENSION extension_name;

-- List installed extensions
\dx
```

### 16.2. Extensions phổ biến

**pg_stat_statements - Query statistics**

```sql
CREATE EXTENSION pg_stat_statements;

-- Top slow queries
SELECT query, calls, mean_exec_time, total_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

**pgcrypto - Cryptographic functions**

```sql
CREATE EXTENSION pgcrypto;

-- Hash password
SELECT crypt('mypassword', gen_salt('bf'));

-- Generate UUID
SELECT gen_random_uuid();
```

**hstore - Key-value store**

```sql
CREATE EXTENSION hstore;

-- Create table with hstore
CREATE TABLE items (
  id serial PRIMARY KEY,
  attributes hstore
);

-- Insert
INSERT INTO items (attributes) VALUES ('color => "red", size => "large"');

-- Query
SELECT * FROM items WHERE attributes -> 'color' = 'red';
```

**uuid-ossp - UUID generation**

```sql
CREATE EXTENSION "uuid-ossp";

-- Generate UUID
SELECT uuid_generate_v4();
```

**postgis - Geographic objects (GIS)**

```sql
CREATE EXTENSION postgis;

-- Now you can store and query geographic data
```

---

## Tham khảo

- [PostgreSQL Official Documentation](https://www.postgresql.org/docs/)
- [PostgreSQL Wiki](https://wiki.postgresql.org/)
- [PgTune - PostgreSQL Configuration Wizard](https://pgtune.leopard.in.ua/)
- [AWS RDS PostgreSQL Best Practices](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html)
- [PostgreSQL Performance Tuning](https://www.postgresql.org/docs/current/performance-tips.html)
