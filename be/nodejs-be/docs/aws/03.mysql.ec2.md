# Hướng dẫn cài đặt MySQL trên AWS EC2 Instance (Amazon Linux)

> **Lưu ý**: File này hướng dẫn cài đặt MySQL Server trên Amazon Linux EC2 instance. Nếu bạn sử dụng Ubuntu, vui lòng xem file [03.mysql.ec2.ubuntu.md](./03.mysql.ec2.ubuntu.md)

## Tổng quan

Trên Windows, người ta thường sử dụng **MySQL Installer** để cài đặt MySQL Server và MySQL Workbench với giao diện đồ họa.
Trên Linux, chúng ta sử dụng **command line** để cài đặt MySQL Server và MySQL Client.

---

## 1. Chuẩn bị môi trường

### 1.1. Cài đặt EPEL Repository (Optional)

EPEL (Extra Packages for Enterprise Linux) cung cấp các gói phần mềm bổ sung cho Amazon Linux.

```bash
sudo amazon-linux-extras install epel -y
```

**Giải thích lệnh:**

- `sudo`: Chạy lệnh với quyền superuser (root)
- `amazon-linux-extras`: Công cụ quản lý packages đặc biệt của Amazon Linux
- `install epel`: Cài đặt EPEL repository
- `-y`: Tự động trả lời "yes" cho tất cả các câu hỏi xác nhận

### 1.2. Về YUM Package Manager

**YUM** (Yellowdog Updater Modified) là một package manager được sử dụng trên các hệ điều hành Linux được phát triển bởi Red Hat như:

- CentOS
- Fedora
- Amazon Linux

YUM cho phép người dùng:

- ✅ Cài đặt packages (`yum install`)
- ✅ Cập nhật packages (`yum update`)
- ✅ Xóa packages (`yum remove`)
- ✅ Quản lý dependencies tự động

---

## 2. Cài đặt MySQL Server

### 2.1. Tải và cài đặt MySQL Repository

Truy cập <https://dev.mysql.com/downloads/repo/yum/> để tìm phiên bản MySQL mới nhất.

**Cách 1: Cài đặt trực tiếp từ YUM (nếu có sẵn)**

```bash
sudo yum install mysql-server -y
```

**Cách 2: Cài đặt từ MySQL Repository chính thức (Khuyến nghị)**

```bash
# Tải và cài đặt MySQL repository package
sudo yum install https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
```

**Giải thích:**

- Link này tải xuống MySQL 8.0 Community Repository cho Enterprise Linux 7
- `.noarch.rpm`: File package không phụ thuộc vào kiến trúc hệ thống (32-bit hay 64-bit)

### 2.2. Cài đặt MySQL Community Server

```bash
sudo yum install mysql-community-server -y
```

**Giải thích:**

- `mysql-community-server`: Package chính chứa MySQL Server
- Hệ thống sẽ hỏi xác nhận, chọn **YES** hoặc thêm flag `-y` để tự động xác nhận

---

## 3. Khởi động và quản lý MySQL Service

### 3.1. Về systemctl

**systemctl** là công cụ quản lý services trên Linux sử dụng systemd. Các lệnh thông dụng:

| Lệnh | Mô tả |
|------|-------|
| `systemctl start <service>` | Khởi động service |
| `systemctl stop <service>` | Dừng service |
| `systemctl restart <service>` | Khởi động lại service |
| `systemctl status <service>` | Xem trạng thái service |
| `systemctl enable <service>` | Tự động khởi động service khi boot |

### 3.2. Khởi động MySQL

```bash
# Khởi động MySQL service
sudo systemctl start mysqld

# Kiểm tra trạng thái
sudo systemctl status mysqld
```

**Giải thích:**

- `mysqld`: MySQL daemon (service name)
- `status`: Hiển thị trạng thái service (running, stopped, failed, etc.)

### 3.3. Enable auto-start khi reboot (Khuyến nghị)

```bash
sudo systemctl enable mysqld
```

---

## 4. Lấy mật khẩu root tạm thời

Khi cài đặt lần đầu, MySQL tự động tạo một **mật khẩu tạm thời** cho user `root` và lưu trong log file.

### 4.1. Về lệnh grep và cat

**grep** (Global Regular Expression Print):

- Tìm kiếm văn bản theo pattern trong file
- Syntax: `grep [options] pattern [file]`
- Options thông dụng:
  - `-i`: Không phân biệt hoa thường
  - `-r`: Tìm kiếm đệ quy trong thư mục
  - `-n`: Hiển thị số dòng

**cat** (Concatenate):

- Đọc và hiển thị nội dung file
- Syntax: `cat [options] [file]`
- Thường được dùng kết hợp với pipe `|` để xử lý output

### 4.2. Tìm mật khẩu tạm thời

**Cách 1: Sử dụng grep trực tiếp**

```bash
sudo grep 'temporary password' /var/log/mysqld.log
```

**Cách 2: Sử dụng cat kết hợp pipe**

```bash
sudo cat /var/log/mysqld.log | grep 'temporary password'
```

**Giải thích:**

- Cần `sudo` vì file log thuộc quyền root
- `/var/log/mysqld.log`: Đường dẫn file log của MySQL
- `|` (pipe): Chuyển output của lệnh bên trái làm input cho lệnh bên phải
- Output sẽ dạng: `A temporary password is generated for root@localhost: Abc123Xyz!`

---

## 5. Đăng nhập và đổi mật khẩu root

### 5.1. Đăng nhập MySQL

```bash
mysql -u root -p
```

**Giải thích:**

- `-u root`: Đăng nhập với username là `root`
- `-p`: Yêu cầu nhập password (sẽ hiện prompt để nhập mật khẩu)

Nhập mật khẩu tạm thời vừa tìm được ở bước 4.

### 5.2. Đổi mật khẩu root

Sau khi đăng nhập thành công vào MySQL, chạy lệnh SQL sau:

```sql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'YourNewPassword123!';
```

**Giải thích:**

- `ALTER USER`: Lệnh SQL để thay đổi thông tin user
- `'root'@'localhost'`: User root chỉ được phép kết nối từ localhost
- `IDENTIFIED WITH mysql_native_password`: Sử dụng phương thức xác thực native (tương thích tốt)
- `BY 'YourNewPassword123!'`: Mật khẩu mới (phải đủ mạnh: chữ hoa, chữ thường, số, ký tự đặc biệt)

**Lưu ý:** MySQL 8.0 có policy mật khẩu mạnh mặc định. Mật khẩu phải có:

- Ít nhất 8 ký tự
- Chữ hoa, chữ thường, số, ký tự đặc biệt

### 5.3. Thoát khỏi MySQL

```bash
exit
```

hoặc

```bash
quit;
```

---

## 6. Import dữ liệu từ file SQL

### 6.1. Chuẩn bị file SQL

Giả sử bạn có file `mysqlsampledatabase.sql` trên máy local.

### 6.2. Về lệnh SCP

**SCP** (Secure Copy Protocol):

- Copy file an toàn giữa local và remote server qua SSH
- Syntax: `scp [options] source destination`
- Options thông dụng:
  - `-i <key_file>`: Sử dụng private key để xác thực
  - `-r`: Copy đệ quy (cho thư mục)
  - `-P <port>`: Chỉ định port SSH (mặc định 22)

### 6.3. Copy file SQL từ local lên EC2

```bash
scp -i "~/.ssh/your_key.pem" /path/to/mysqlsampledatabase.sql ec2-user@your-ec2-public-ip:/home/ec2-user/
```

**Giải thích từng phần:**

- `-i "~/.ssh/your_key.pem"`: Sử dụng private key để xác thực SSH
  - `~`: Thư mục home của user hiện tại
  - `.ssh/`: Thư mục chứa SSH keys
- `/path/to/mysqlsampledatabase.sql`: Đường dẫn file SQL trên máy local
- `ec2-user`: Username mặc định của Amazon Linux EC2 instance
- `@your-ec2-public-ip`: IP public của EC2 instance (có thể copy từ AWS Console)
- `:/home/ec2-user/`: Thư mục đích trên server

**Cách viết ngắn gọn hơn:**

```bash
scp -i "~/.ssh/your_key.pem" /path/to/mysqlsampledatabase.sql ec2-user@your-ec2-public-ip:~/
```

**Giải thích:**

- `~/`: Tương đương `/home/ec2-user/` - thư mục home của user hiện tại trên server

### 6.4. Import file SQL vào MySQL

**Bước 1:** SSH vào EC2 instance

```bash
ssh -i "~/.ssh/your_key.pem" ec2-user@your-ec2-public-ip
```

**Bước 2:** Đăng nhập MySQL

```bash
mysql -u root -p
```

**Bước 3:** Tạo database (nếu chưa có)

```sql
CREATE DATABASE IF NOT EXISTS your_database_name;
USE your_database_name;
```

**Bước 4:** Import file SQL

```sql
SOURCE /home/ec2-user/mysqlsampledatabase.sql;
```

**Giải thích:**

- `SOURCE`: Lệnh MySQL để thực thi các câu lệnh SQL trong file
- Đường dẫn phải là absolute path trên server

**Bước 5:** Kiểm tra dữ liệu

```sql
SHOW TABLES;
SELECT * FROM table_name LIMIT 10;
```

### 6.5. Import trực tiếp từ command line (Không cần vào MySQL CLI)

```bash
mysql -u root -p your_database_name < /home/ec2-user/mysqlsampledatabase.sql
```

**Giải thích:**

- `< file.sql`: Redirect input từ file SQL vào MySQL
- Cách này nhanh hơn và phù hợp cho automation

---

## 7. Các lệnh MySQL hữu ích

```bash
# Khởi động lại MySQL
sudo systemctl restart mysqld

# Dừng MySQL
sudo systemctl stop mysqld

# Xem log MySQL (troubleshooting)
sudo tail -f /var/log/mysqld.log

# Kiểm tra version MySQL
mysql --version

# Backup database
mysqldump -u root -p database_name > backup.sql

# Restore database
mysql -u root -p database_name < backup.sql
```

**Giải thích `tail`:**

- `tail`: Hiển thị phần cuối của file
- `-f` (follow): Theo dõi file real-time (cập nhật liên tục khi có log mới)
- Hữu ích khi debug MySQL

---

## 8. Security Configuration (Khuyến nghị)

### 8.1. Chạy MySQL Secure Installation

```bash
sudo mysql_secure_installation
```

Script này sẽ hướng dẫn:

- ✅ Đặt validate password policy
- ✅ Xóa anonymous users
- ✅ Tắt remote root login
- ✅ Xóa test database
- ✅ Reload privilege tables

### 8.2. Cấu hình Firewall (nếu cần remote access)

```bash
# Mở port 3306 (MySQL default port)
sudo firewall-cmd --zone=public --add-port=3306/tcp --permanent
sudo firewall-cmd --reload

# Hoặc sử dụng iptables
sudo iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
```

**⚠️ Cảnh báo bảo mật:**

- Không nên mở port 3306 ra internet trực tiếp
- Nên sử dụng SSH tunneling hoặc VPN
- Cấu hình Security Group trên AWS để chỉ cho phép IP cụ thể

---

## 9. Troubleshooting

### 9.1. MySQL không khởi động được

```bash
# Kiểm tra log lỗi
sudo cat /var/log/mysqld.log

# Kiểm tra status chi tiết
sudo systemctl status mysqld -l

# Kiểm tra port 3306 có bị chiếm không
sudo netstat -tuln | grep 3306
```

### 9.2. Quên mật khẩu root

```bash
# Dừng MySQL
sudo systemctl stop mysqld

# Khởi động MySQL ở chế độ skip password
sudo mysqld_safe --skip-grant-tables &

# Đăng nhập không cần password
mysql -u root

# Reset password
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY 'NewPassword123!';
exit

# Khởi động lại MySQL bình thường
sudo systemctl restart mysqld
```

---

## Tham khảo

- [MySQL Official Documentation](https://dev.mysql.com/doc/)
- [AWS EC2 User Guide](https://docs.aws.amazon.com/ec2/)
- [MySQL Installer Downloads](https://dev.mysql.com/downloads/installer/)
